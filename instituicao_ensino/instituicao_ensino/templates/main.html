{% extends 'base/base.html' %}
{% load static %}

{% block title %}Home{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'styles/main.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4 home-page">

    {% if destaques %}
    <div id="destaquesCarousel" class="carousel slide mb-5" data-bs-ride="carousel">
        <div class="carousel-inner rounded shadow-lg">
            {% for ev in destaques %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                <a href="{% url 'detalhe_evento' ev.id %}">
                    {% if ev.thumb %}
                        <img src="{{ ev.thumb.url }}" class="d-block w-100" alt="{{ ev.titulo }}">
                    {% else %}
                        <img src="{% static 'favicon.png' %}" class="d-block w-100" alt="placeholder">
                    {% endif %}
                    <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded p-3">
                        <h5 class="fw-bold text-warning">{{ ev.titulo }}</h5>
                        <p class="small text-light">{{ ev.data_inicio|date:"d/m/Y" }}</p>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#destaquesCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#destaquesCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
        </button>
    </div>
    {% endif %}

    <h2 class="section-title text-center mb-4">Eventos Ativos</h2>

    <div id="eventGrid" class="event-grid">
        {% for ev in ativos %}
        <div class="event-card-wrapper" data-index="{{ forloop.counter }}">
            <div class="event-card">
                <!-- Frente do Card -->
                <div class="card-front">
                    <div class="event-image-container">
                        {% if ev.thumb %}
                            <img src="{{ ev.thumb.url }}" alt="{{ ev.titulo }}" class="event-img">
                        {% else %}
                            <img src="{% static 'favicon.png' %}" alt="placeholder" class="event-img">
                        {% endif %}
                        <div class="image-overlay">
                            <div class="event-date-badge">
                                <span class="date-day">{{ ev.data_inicio|date:"d" }}</span>
                                <span class="date-month">{{ ev.data_inicio|date:"M" }}</span>
                            </div>
                            <div class="event-status-indicator">
                                {% if ev.inscricaoevento_set.count < ev.quantidade_participantes or ev.sem_limites %}
                                    <span class="status-open">Vagas Abertas</span>
                                {% else %}
                                    <span class="status-full">Lotado</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="card-front-content">
                        <div class="event-header">
                            <h5 class="event-title">{{ ev.titulo }}</h5>
                            <div class="event-category">
                                <i class="fas fa-graduation-cap"></i> {{ev.tipo.tipo|default:'Acadêmico'}}
                            </div>
                        </div>

                        <div class="event-info-grid">
                            <div class="info-cell">
                                <i class="fas fa-clock"></i>
                                <div class="cell-content">
                                    <span class="cell-label">Horário</span>
                                    <span class="cell-value">{{ ev.horario|default:"A definir" }}</span>
                                </div>
                            </div>

                            <div class="info-cell">
                                <i class="fas fa-users"></i>
                                <div class="cell-content">
                                    <span class="cell-label">Vagas</span>
                                    <span class="cell-value vagas-count">
                                        {{ ev.inscricaoevento_set.count }}
                                        {% if not ev.sem_limites and ev.quantidade_participantes %}
                                            /{{ ev.quantidade_participantes }}
                                        {% elif ev.sem_limites %}
                                            /Ilimitado
                                        {% else %}
                                            /--
                                        {% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="info-cell">
                                <i class="fas fa-map-marker-alt"></i>
                                <div class="cell-content">
                                    <span class="cell-label">Local</span>
                                    <span class="cell-value">
                                        {% if ev.local %}
                                            {{ ev.local|truncatechars:25 }}
                                        {% elif ev.link %}
                                            Online
                                        {% else %}
                                            A definir
                                        {% endif %}
                                    </span>
                                </div>
                            </div>

                            {% if ev.link %}
                            <div class="info-cell">
                                <i class="fas fa-link"></i>
                                <div class="cell-content">
                                    <span class="cell-label">Acesso</span>
                                    <a href="{{ ev.link }}" target="_blank" class="cell-value text-primary text-decoration-underline">
                                        Abrir Link
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <div class="flip-cta">
                            <i class="fas fa-info-circle"></i> Clique para ver detalhes
                        </div>
                    </div>
                </div>

                <!-- Verso do Card -->
                <div class="card-back">
                    <div class="card-back-container">
                        <div class="back-header">
                            <div class="back-title-section">
                                <h5 class="event-title-back">{{ ev.titulo }}</h5>
                                <div class="event-meta-quick">
                                    <span class="meta-badge"><i class="fas fa-calendar"></i> {{ ev.data_inicio|date:"d/m/Y" }}</span>
                                    <span class="meta-badge"><i class="fas fa-clock"></i> {{ ev.horario|default:"A definir" }}</span>
                                </div>
                            </div>
                            <button class="close-back" onclick="event.stopPropagation(); this.closest('.event-card').classList.remove('flipped')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="scroll-content">
                            <div class="description-section">
                                <h6 class="section-title-back">
                                    <i class="fas fa-file-alt"></i> Descrição
                                </h6>
                                <div class="event-description">
                                    {{ ev.descricao|default:"Descrição não informada."|linebreaks }}
                                </div>
                            </div>

                            <div class="details-section">
                                <h6 class="section-title-back">
                                    <i class="fas fa-info-circle"></i> Detalhes
                                </h6>
                                <div class="details-grid">
                                    <div class="detail-item">
                                        <i class="fas fa-user-tie"></i>
                                        <div class="detail-content">
                                            <strong>Organizador</strong>
                                            <span>{{ ev.criador|default:"Não informado" }}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="detail-item">
                                        <i class="fas fa-university"></i>
                                        <div class="detail-content">
                                            <strong>Instituição</strong>
                                            <span>{{ ev.criador.instituicao|default:"Não informada" }}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="detail-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <div class="detail-content">
                                            <strong>Local</strong>
                                            <span>
                                                {% if ev.local %}
                                                    {{ ev.local }}
                                                {% elif ev.link %}
                                                    Evento Online
                                                {% else %}
                                                    A definir
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>

                                    {% if ev.link %}
                                    <div class="detail-item">
                                        <i class="fas fa-external-link-alt"></i>
                                        <div class="detail-content">
                                            <strong>Link</strong>
                                            <a href="{{ ev.link }}" target="_blank" class="event-link-back text-primary">
                                                {{ ev.link|truncatechars:40 }}
                                            </a>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <div class="detail-item">
                                        <i class="fas fa-users"></i>
                                        <div class="detail-content">
                                            <strong>Vagas</strong>
                                            <span>
                                                {{ ev.inscricaoevento_set.count }} inscritos 
                                                {% if ev.quantidade_participantes %}
                                                    de {{ ev.quantidade_participantes }}
                                                {% else %}
                                                    (Ilimitado)
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>

                                    <div class="detail-item">
                                        <i class="fas fa-tag"></i>
                                        <div class="detail-content">
                                            <strong>Modalidade</strong>
                                            <span>{{ ev.get_modalidade_display }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="back-actions">
                            <a href="{% url 'detalhe_evento' ev.id %}" class="btn btn-secondary">
                                <i class="fas fa-info-circle"></i> Ver Detalhes
                            </a>

                            {% if current_usuario %}
                                {% if ev.criador == current_usuario %}
                                    <a href="{% url 'gerenciar_evento' ev.id %}" class="btn btn-warning">
                                        <i class="fas fa-cog"></i> Gerenciar Evento
                                    </a>
                                {% else %}
                                    {% if ev.id in inscricoes_usuario %}
                                        <form action="{% url 'detalhe_evento' ev.id %}" method="POST" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger">
                                                <i class="fas fa-times"></i> Cancelar Inscrição
                                            </button>
                                        </form>
                                    {% else %}
                                        <a href="{% url 'detalhe_evento' ev.id %}#inscricao" class="btn btn-primary">
                                            <i class="fas fa-user-plus"></i> Inscrever-se
                                        </a>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-outline-primary">
                                    <i class="fas fa-sign-in-alt"></i> Entrar para Inscrever-se
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if ativos|length > 6 %}
    <div class="text-center mt-5 mb-4">
        <button id="showMoreBtn" class="btn btn-load-more">
            <span class="btn-text">Mostrar mais eventos</span>
            <span class="btn-loading" style="display: none;">
                <i class="fas fa-spinner fa-spin me-2"></i>Carregando...
            </span>
        </button>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const cards = document.querySelectorAll(".event-card-wrapper");
    const btn = document.getElementById("showMoreBtn");
    const batchSize = 3;
    let visibleCount = 6;

    cards.forEach((card, idx) => {
        if (idx >= visibleCount) card.style.display = "none";
    });

    cards.forEach(card => {
        const eventCard = card.querySelector('.event-card');
        eventCard.addEventListener('click', function(e) {
            if (e.target.tagName === 'A' || e.target.closest('a') || e.target.closest('.close-back')) return;
            this.classList.toggle('flipped');
        });
    });

    btn?.addEventListener("click", function() {
        const btnText = this.querySelector(".btn-text");
        const btnLoading = this.querySelector(".btn-loading");
        btnText.style.display = "none";
        btnLoading.style.display = "inline-block";

        setTimeout(() => {
            const nextBatch = visibleCount + batchSize;
            for (let i = visibleCount; i < nextBatch && i < cards.length; i++) {
                cards[i].style.display = "block";
                cards[i].style.opacity = "1";
                cards[i].style.transform = "translateY(0)";
            }
            visibleCount = nextBatch;
            if (visibleCount >= cards.length) this.style.display = "none";
            btnText.style.display = "inline-block";
            btnLoading.style.display = "none";
        }, 400);
    });

    document.addEventListener('click', e => {
        if (!e.target.closest('.event-card')) {
            document.querySelectorAll('.event-card.flipped').forEach(c => c.classList.remove('flipped'));
        }
    });
});
</script>
{% endblock %}